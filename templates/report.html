{% extends 'base.html' %}

{% block content %}
<div class="max-w-2xl mx-auto py-12 px-4 sm:px-6 lg:px-8">
    <div class="bg-white overflow-hidden shadow rounded-lg">
        <div class="px-4 py-5 sm:p-6">
            <div class="flex flex-col sm:flex-row justify-between items-start sm:items-center mb-6 border-b pb-4 gap-4">
                <h2 class="text-2xl font-bold leading-7 text-gray-900 sm:text-3xl sm:truncate">
                    üìù Report Waste
                </h2>
                <div class="flex items-center gap-3">
                    <span id="cleanup-text" class="text-sm text-gray-500 font-medium flex items-center gap-1">
                        üßπ Clean-up mode is currently off
                    </span>
                    <button type="button" id="cleanup-toggle-btn" onclick="toggleCleanupMode()"
                        class="bg-gray-200 text-gray-700 px-3 py-1 rounded-full text-xs font-bold transition-colors duration-200 focus:outline-none focus:ring-2 focus:ring-primary focus:ring-offset-2 w-12">
                        OFF
                    </button>
                </div>
            </div>

            {% if error %}
            <div class="rounded-md bg-red-50 p-4 mb-6 border border-red-200">
                <div class="flex">
                    <div class="flex-shrink-0">
                        <i class="fas fa-exclamation-circle text-red-500 text-xl"></i>
                    </div>
                    <div class="ml-3">
                        <h3 class="text-sm font-medium text-red-800">Submission Failed</h3>
                        <div class="mt-2 text-sm text-red-700">
                            {{ error }}
                        </div>
                    </div>
                </div>
            </div>
            {% endif %}

            {% with messages = get_flashed_messages(with_categories=true) %}
            {% if messages %}
            {% for category, message in messages %}
            <div class="rounded-md bg-red-50 p-4 mb-6 border border-red-200">
                <div class="flex">
                    <div class="flex-shrink-0">
                        <i class="fas fa-exclamation-circle text-red-500 text-xl"></i>
                    </div>
                    <div class="ml-3">
                        <h3 class="text-sm font-medium text-red-800">Error</h3>
                        <div class="mt-2 text-sm text-red-700">
                            {{ message }}
                        </div>
                    </div>
                </div>
            </div>
            {% endfor %}
            {% endif %}
            {% endwith %}

            {% if success %}
            <div class="rounded-md bg-green-50 p-4 mb-4">
                <div class="flex">
                    <div class="flex-shrink-0">
                        <i class="fas fa-check-circle text-green-400 text-xl"></i>
                    </div>
                    <div class="ml-3">
                        <h3 class="text-sm font-medium text-green-800">Report Submitted Successfully!</h3>
                        <div class="mt-2 text-sm text-green-700">
                            <p>Your Tracking ID is: <strong class="text-lg font-bold">{{ report_id }}</strong></p>
                            <p>Please save this ID to check your status later.</p>
                        </div>
                        <div class="mt-4">
                            <div class="-mx-2 -my-1.5 flex">
                                <a href="{{ url_for('index') }}"
                                    class="bg-green-50 px-2 py-1.5 rounded-md text-sm font-medium text-green-800 hover:bg-green-100 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-green-500">
                                    Back Home
                                </a>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            {% else %}
            <form method="POST" id="reportForm" enctype="multipart/form-data" class="space-y-6">

                <div>
                    <label class="block text-sm font-medium text-gray-700">üì∏ Evidence (Required)</label>

                    <!-- File Upload Area -->
                    <div id="file-upload-area"
                        class="mt-1 flex justify-center px-6 pt-5 pb-6 border-2 border-gray-300 border-dashed rounded-md hover:border-primary transition-colors">
                        <div class="space-y-1 text-center">
                            <i class="fas fa-image text-gray-400 text-3xl mb-3"></i>
                            <div class="flex flex-col items-center text-sm text-gray-600 gap-2">
                                <label for="file-upload"
                                    class="relative cursor-pointer bg-white rounded-md font-medium text-primary hover:text-green-500 focus-within:outline-none focus-within:ring-2 focus-within:ring-offset-2 focus-within:ring-primary">
                                    <span>Upload a file</span>
                                    <input id="file-upload" name="image" type="file" accept="image/*" class="sr-only">
                                </label>
                                <span>or</span>
                                <button type="button" onclick="startCamera()"
                                    class="text-primary hover:text-green-500 font-medium focus:outline-none">
                                    <i class="fas fa-camera"></i> Use Camera
                                </button>
                            </div>
                            <p class="text-xs text-gray-500">PNG, JPG, GIF up to 10MB</p>
                            <p id="file-name-display" class="text-sm text-gray-700 mt-2 font-semibold"></p>
                        </div>
                    </div>

                    <!-- Camera Interface (Hidden by default) -->
                    <div id="camera-interface" class="hidden mt-4">
                        <div class="relative bg-black rounded-lg overflow-hidden shadow-lg aspect-video">
                            <video id="camera-feed" autoplay playsinline class="w-full h-full object-cover"></video>
                            <canvas id="camera-canvas" class="hidden"></canvas>
                        </div>
                        <div class="mt-2 flex justify-center gap-4">
                            <button type="button" onclick="capturePhoto()"
                                class="inline-flex items-center px-4 py-2 border border-transparent text-sm font-medium rounded-md text-white bg-red-600 hover:bg-red-700 focus:outline-none">
                                <i class="fas fa-camera mr-2"></i> Capture
                            </button>
                            <button type="button" onclick="stopCamera()"
                                class="inline-flex items-center px-4 py-2 border border-gray-300 shadow-sm text-sm font-medium rounded-md text-gray-700 bg-white hover:bg-gray-50 focus:outline-none">
                                Cancel
                            </button>
                        </div>
                    </div>

                    <!-- Captured Image Preview (Hidden by default) -->
                    <div id="captured-preview" class="hidden mt-4 text-center">
                        <img id="preview-image" src=""
                            class="mx-auto rounded-lg shadow-lg max-h-64 object-cover border-4 border-white">
                        <div class="mt-2 text-sm text-green-600 font-medium">
                            <i class="fas fa-check-circle"></i> Photo Captured
                        </div>

                        <!-- Filename Edit -->
                        <div class="mt-3 flex justify-center items-center gap-2">
                            <label for="custom-filename" class="text-xs text-gray-500 uppercase font-bold">File
                                Name:</label>
                            <div class="flex rounded-md shadow-sm">
                                <input type="text" id="custom-filename"
                                    class="flex-1 min-w-0 block w-48 rounded-none rounded-l-md sm:text-sm border-gray-300 focus:ring-primary focus:border-primary p-1 border"
                                    placeholder="filename">
                                <span
                                    class="inline-flex items-center px-3 rounded-r-md border border-l-0 border-gray-300 bg-gray-50 text-gray-500 sm:text-sm">
                                    .jpg
                                </span>
                            </div>
                        </div>

                        <button type="button" onclick="retakePhoto()"
                            class="mt-3 text-sm text-red-500 hover:text-red-700 underline">
                            Remove & Retake
                        </button>
                    </div>

                </div>

                <div>
                    <label class="block text-sm font-medium text-gray-700">üìù Description</label>
                    <div class="mt-1">
                        <textarea name="description" rows="3"
                            class="shadow-sm focus:ring-primary focus:border-primary mt-1 block w-full sm:text-sm border border-gray-300 rounded-md p-2"
                            placeholder="Describe the waste..." required></textarea>
                    </div>
                </div>

                <div>
                    <label class="block text-sm font-medium text-gray-700">üìç Location Name</label>
                    <div class="mt-1 flex gap-2">
                        <input type="text" name="location_name"
                            class="shadow-sm focus:ring-primary focus:border-primary block w-full sm:text-sm border-gray-300 rounded-md p-2 border"
                            placeholder="Enter landmark (e.g. Near Bus Stop)" required>
                        <button type="button" onclick="searchLocation()"
                            class="inline-flex items-center px-3 py-2 border border-gray-300 shadow-sm text-sm font-medium rounded-md text-gray-700 bg-white hover:bg-gray-50 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-primary">
                            <i class="fas fa-search"></i>
                        </button>
                    </div>
                </div>

                <div>
                    <label class="block text-sm font-medium text-gray-700">‚ö†Ô∏è Severity</label>
                    <select name="severity"
                        class="mt-1 block w-full pl-3 pr-10 py-2 text-base border-gray-300 focus:outline-none focus:ring-primary focus:border-primary sm:text-sm rounded-md border">
                        <option value="Low">üü¢ Low</option>
                        <option value="Medium">üü† Medium</option>
                        <option value="High">üî¥ High</option>
                    </select>
                </div>

                <div>
                    <label class="block text-sm font-medium text-gray-700">üìç Map Coordinates (Optional)</label>
                    <div class="mt-1 flex flex-col gap-4">
                        <div class="flex items-center gap-4">
                            <button type="button" onclick="getLocation()"
                                class="inline-flex items-center px-4 py-2 border border-transparent text-sm font-medium rounded-md text-white bg-gray-600 hover:bg-gray-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-gray-500">
                                <i class="fas fa-location-arrow mr-2"></i> Use My Current Location
                            </button>
                            <span id="location-status" class="text-sm text-gray-500"></span>
                        </div>
                        <!-- Manual Map Picker -->
                        <div id="map-picker" class="h-64 w-full rounded-md border border-gray-300 z-0"></div>
                        <p class="text-xs text-gray-500">Tip: Drag the marker or click on the map to set location
                            manually.</p>
                    </div>
                </div>

                <input type="hidden" id="latitude" name="latitude">
                <input type="hidden" id="longitude" name="longitude">

                <!-- Simple CAPTCHA -->
                <div class="bg-blue-50 p-4 rounded-md border border-blue-100">
                    <label class="block text-sm font-medium text-blue-900 mb-2">ü§ñ Human Verification</label>
                    <div class="flex items-center gap-3">
                        <span class="text-lg font-bold text-blue-800 bg-white px-3 py-1 rounded shadow-sm">
                            {{ captcha_question }} = ?
                        </span>
                        <input type="number" name="captcha_answer" required
                            class="shadow-sm focus:ring-primary focus:border-primary block w-24 sm:text-sm border-gray-300 rounded-md p-2 border"
                            placeholder="Answer">
                    </div>
                    <p class="text-xs text-blue-600 mt-1">Please solve the math problem to prove you are human.</p>
                </div>

                <div class="pt-5">
                    <button type="submit"
                        class="w-full flex justify-center py-2 px-4 border border-transparent rounded-md shadow-sm text-sm font-medium text-white bg-primary hover:bg-green-600 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-primary transition-colors">
                        Submit Report
                    </button>
                </div>
            </form>
            {% endif %}
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
    // --- Camera Logic ---
    let stream = null;
    let currentBlob = null; // Store blob to recreate file when renaming
    const video = document.getElementById('camera-feed');
    const canvas = document.getElementById('camera-canvas');
    const fileInput = document.getElementById('file-upload');
    const cameraInterface = document.getElementById('camera-interface');
    const capturedPreview = document.getElementById('captured-preview');
    const previewImage = document.getElementById('preview-image');
    const uploadArea = document.getElementById('file-upload-area');
    const fileNameDisplay = document.getElementById('file-name-display');
    const filenameInput = document.getElementById('custom-filename');

    // Handle File Input Change (Show filename)
    fileInput.addEventListener('change', function (e) {
        if (this.files && this.files[0]) {
            fileNameDisplay.textContent = "Selected: " + this.files[0].name;
            // Also show preview if it's an image (optional, but good UX)
            // If manual upload, hide camera preview if open
            if (stream) stopCamera();
            capturedPreview.classList.add('hidden');
        } else {
            fileNameDisplay.textContent = "";
        }
    });

    // Handle Filename Change
    filenameInput.addEventListener('input', function () {
        if (currentBlob) {
            updateFileInputWithBlob(currentBlob, this.value);
        }
    });

    async function startCamera() {
        try {
            stream = await navigator.mediaDevices.getUserMedia({ video: { facingMode: 'environment' } });
            video.srcObject = stream;
            cameraInterface.classList.remove('hidden');
            uploadArea.classList.add('hidden');
            capturedPreview.classList.add('hidden');
        } catch (err) {
            console.error("Error accessing camera:", err);
            alert("Could not access camera. Please allow permissions or use file upload.");
        }
    }

    function stopCamera() {
        if (stream) {
            stream.getTracks().forEach(track => track.stop());
            stream = null;
        }
        video.srcObject = null;
        cameraInterface.classList.add('hidden');
        uploadArea.classList.remove('hidden');
    }

    function capturePhoto() {
        if (!stream) return;

        // Set canvas dimensions to match video
        canvas.width = video.videoWidth;
        canvas.height = video.videoHeight;

        // Draw frame to canvas
        const context = canvas.getContext('2d');
        context.drawImage(video, 0, 0, canvas.width, canvas.height);

        // Convert to Blob/File
        canvas.toBlob(function (blob) {
            currentBlob = blob;
            const defaultName = "camera_capture_" + Date.now();

            // Set input value
            filenameInput.value = defaultName;

            // Update File Input
            updateFileInputWithBlob(blob, defaultName);

            // Update UI
            previewImage.src = URL.createObjectURL(blob);
            stopCamera(); // Stop the video stream

            uploadArea.classList.add('hidden'); // Keep upload area hidden
            capturedPreview.classList.remove('hidden'); // Show the captured image
            fileNameDisplay.textContent = ""; // Clear manual upload text

        }, 'image/jpeg', 0.8);
    }

    function updateFileInputWithBlob(blob, name) {
        // Ensure name has extension (optional safety, though flask secure_filename handles it generally, we add suffix in UI)
        // We will append .jpg in the file object construction since the UI shows it as separate suffix
        const fullFileName = (name || "image") + ".jpg";

        const file = new File([blob], fullFileName, { type: "image/jpeg" });

        // Populate file input
        const dataTransfer = new DataTransfer();
        dataTransfer.items.add(file);
        fileInput.files = dataTransfer.files;
    }

    function retakePhoto() {
        fileInput.value = ""; // Clear input
        currentBlob = null;
        capturedPreview.classList.add('hidden');
        startCamera(); // Restart camera
    }


    // --- Map Logic ---
    // Initialize Leaflet Map
    var mapPicker = L.map('map-picker', {
        maxBounds: [[5.0, 65.0], [40.0, 100.0]],
        maxBoundsViscosity: 1.0,
        minZoom: 4
    }).setView([20.5937, 78.9629], 4); // Default: India center
    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
        attribution: '&copy; OpenStreetMap contributors'
    }).addTo(mapPicker);

    var marker = L.marker([20.5937, 78.9629], { draggable: true }).addTo(mapPicker);

    // Sync Marker -> Inputs
    function updateLocationFromMarker(lat, lng, source = "Manual") {
        document.getElementById('latitude').value = lat;
        document.getElementById('longitude').value = lng;
        if (source === "Manual") {
            document.getElementById('location-status').innerHTML = `<span class="text-blue-600 font-medium">üìç Location Selected on Map</span>`;
        }
    }

    marker.on('dragend', function (e) {
        var position = marker.getLatLng();
        updateLocationFromMarker(position.lat, position.lng);
    });

    mapPicker.on('click', function (e) {
        marker.setLatLng(e.latlng);
        updateLocationFromMarker(e.latlng.lat, e.latlng.lng);
    });

    // Sync GPS -> Map & Inputs
    function getLocation() {
        const status = document.getElementById('location-status');
        if (navigator.geolocation) {
            status.innerHTML = '<span class="text-yellow-600"><i class="fas fa-spinner fa-spin"></i> Detecting...</span>';
            navigator.geolocation.getCurrentPosition(showPosition, showError);
        } else {
            status.innerHTML = '<span class="text-red-500">‚ùå Not supported by browser.</span>';
        }
    }

    function showPosition(position) {
        const lat = position.coords.latitude;
        const lng = position.coords.longitude;

        // Update Map
        mapPicker.setView([lat, lng], 16);
        marker.setLatLng([lat, lng]);

        // Update Inputs
        document.getElementById('latitude').value = lat;
        document.getElementById('longitude').value = lng;
        document.getElementById('location-status').innerHTML = '<span class="text-green-600 font-medium">‚úÖ GPS Locked!</span>';
    }

    function showError(error) {
        let msg = "Unknown error";
        switch (error.code) {
            case error.PERMISSION_DENIED: msg = "User denied Geolocation"; break;
            case error.POSITION_UNAVAILABLE: msg = "Location info unavailable"; break;
            case error.TIMEOUT: msg = "Request timed out"; break;
        }
        document.getElementById('location-status').innerHTML = `<span class="text-red-500">‚ùå ${msg}</span>`;
    }

    // Auto-Geocode from Location Name
    const locationInput = document.querySelector('input[name="location_name"]');

    // Search on Blur (when user leaves the text box)
    locationInput.addEventListener('blur', function () {
        // Only trigger if button wasn't clicked (optional)
        // But for simplicity, we allow both. The button is better for feedback.
        if (this.value.length > 3) searchLocation();
    });

    // Explicit Search Function
    function searchLocation() {
        const query = locationInput.value;
        if (!query || query.length < 3) {
            // alert("Please enter a valid location name first!");
            return;
        }

        document.getElementById('location-status').innerHTML = '<span class="text-yellow-600"><i class="fas fa-spinner fa-spin"></i> Searching map for "' + query + '"...</span>';

        // Using OpenStreetMap Nominatim API - Restricted to India
        fetch(`https://nominatim.openstreetmap.org/search?format=json&q=${encodeURIComponent(query)}&countrycodes=in`)
            .then(response => response.json())
            .then(data => {
                if (data && data.length > 0) {
                    const lat = data[0].lat;
                    const lon = data[0].lon;

                    // Update Map
                    mapPicker.setView([lat, lon], 16);
                    marker.setLatLng([lat, lon]);

                    // Update Inputs
                    updateLocationFromMarker(lat, lon, "Auto");
                    const displayName = data[0].display_name.split(',')[0];
                    document.getElementById('location-status').innerHTML = '<span class="text-green-600 font-medium">‚úÖ Found: ' + displayName + '</span>';
                } else {
                    document.getElementById('location-status').innerHTML = '<span class="text-orange-500">Could not find location. Try moving the map marker manually.</span>';
                }
            })
            .catch(err => {
                console.error(err);
                document.getElementById('location-status').innerHTML = '<span class="text-red-500">Error searching location</span>';
            });
    }

    // Fix map sizing
    setTimeout(function () { mapPicker.invalidateSize(); }, 500);

    // --- Clean-up Mode Logic ---
    function toggleCleanupMode() {
        const target = document.getElementById('reportForm') || document.querySelector('.bg-green-50');
        const btn = document.getElementById('cleanup-toggle-btn');
        const txt = document.getElementById('cleanup-text');

        if (target && btn) {
            const isEnabled = target.classList.toggle('cleanup-mode');

            if (isEnabled) {
                btn.textContent = "ON";
                btn.className = "bg-primary text-white px-3 py-1 rounded-full text-xs font-bold transition-colors duration-200 focus:outline-none focus:ring-2 focus:ring-primary focus:ring-offset-2 w-12";
                if (txt) {
                    txt.innerHTML = "üßπ Clean-up mode enabled";
                    txt.classList.add("text-primary");
                }
            } else {
                btn.textContent = "OFF";
                btn.className = "bg-gray-200 text-gray-700 px-3 py-1 rounded-full text-xs font-bold transition-colors duration-200 focus:outline-none focus:ring-2 focus:ring-primary focus:ring-offset-2 w-12";
                if (txt) {
                    txt.innerHTML = "üßπ Clean-up mode is currently off";
                    txt.classList.remove("text-primary");
                }
            }
        }
    }
</script>
{% endblock %}